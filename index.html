<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezinskalender</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    #week { display:grid; grid-template-columns:repeat(7,1fr); gap:16px; margin:16px 0 24px; }
    .day { border:1px solid #ddd; border-radius:12px; padding:12px; min-height:140px; }
    .day strong{ display:block; margin-bottom:8px; }
    .day ul{ margin:0 0 0 18px; padding:0; }
    .muted{ color:#777; }
    .meta{ color:#444; font-size: 14px; margin-top: 4px; }
    form{ margin-top:16px; max-width: 520px; }
    input, select { min-width: 220px; }
    .row{ margin: 10px 0; }
    .small{ font-size: 14px; }
  </style>
</head>
<body>
  <h1>Gezinskalender</h1>

  <h2>Deze week</h2>
  <div id="week"></div>

  <h3>Nieuwe wekelijkse activiteit</h3>
  <form id="rule-form">
    <div class="row">
      <label>Wie:
        <select id="member"></select>
      </label>
    </div>

    <div class="row">
      <label>Titel:
        <input id="title" />
      </label>
    </div>

    <div class="row">
      <label>Locatie:
        <input id="location" placeholder="bv. Sporthal" />
      </label>
    </div>

    <div class="row">
      <label>Dag:
        <select id="weekday">
          <option value="0">Ma</option><option value="1">Di</option><option value="2">Wo</option>
          <option value="3">Do</option><option value="4">Vr</option><option value="5">Za</option><option value="6">Zo</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Start:
        <input type="time" id="start_time" />
      </label>
    </div>

    <div class="row">
      <label>Eind:
        <input type="time" id="end_time" />
      </label>
    </div>

    <div class="row">
      <label>Transport:
        <select id="transport_mode">
          <option value="">(geen)</option>
          <option value="fiets">fiets</option>
          <option value="auto">auto</option>
          <option value="te voet">te voet</option>
          <option value="ov">OV</option>
          <option value="anders">anders</option>
        </select>
      </label>
    </div>

    <div class="row">
      <label>Transport-notitie:
        <input id="transport_notes" placeholder="bv. papa brengt, fiets mee" />
      </label>
    </div>

    <div class="row">
      <label>Begeleider (moet mee):
        <select id="required_chaperone"></select>
      </label>
      <div class="small muted">Laat leeg als niemand verplicht mee moet.</div>
    </div>

    <div class="row">
      <div>Begeleider (kan mee):</div>
      <div id="optional_chaperones" class="small"></div>
    </div>

    <button>Toevoegen</button>
  </form>

  <script>
    const sb = window.supabase.createClient(
      "https://jcwxkicgbctylbdlsbcm.supabase.co",
      "sb_publishable_tF7MRrXQu6x3aBtdvLwmhA_FY4A8Eu3"
    );

    const dayNames = ["Ma","Di","Wo","Do","Vr","Za","Zo"];

    function getMonday(){
      const t=new Date(); const d=(t.getDay()+6)%7;
      const m=new Date(t); m.setDate(t.getDate()-d); m.setHours(0,0,0,0);
      return m;
    }

    function isoDate(d){
      return d.toISOString().slice(0,10);
    }

    let membersCache = [];

    async function loadMembers(){
      const { data, error } = await sb.from("members").select("id,name,role").order("name");
      if (error) return;
      membersCache = data;

      // "Wie" dropdown = iedereen
      member.innerHTML = "";
      data.forEach(m=>{
        const o=document.createElement("option");
        o.value=m.id; o.textContent=m.name; member.appendChild(o);
      });

      // "moet mee" = alleen ouders/verzorgers (hier: role='ouder')
      required_chaperone.innerHTML = `<option value="">(niemand)</option>`;
      data.filter(m=>m.role==="ouder").forEach(m=>{
        const o=document.createElement("option");
        o.value=m.id; o.textContent=m.name; required_chaperone.appendChild(o);
      });

      // "kan mee" checkboxes = ouders
      const wrap = document.getElementById("optional_chaperones");
      wrap.innerHTML = "";
      data.filter(m=>m.role==="ouder").forEach(m=>{
        const id = `opt_${m.id}`;
        const div = document.createElement("div");
        div.innerHTML = `<label><input type="checkbox" id="${id}" value="${m.id}"> ${m.name}</label>`;
        wrap.appendChild(div);
      });
    }

    function getOptionalChaperoneIds(){
      const boxes = document.querySelectorAll("#optional_chaperones input[type=checkbox]");
      return Array.from(boxes).filter(b=>b.checked).map(b=>b.value);
    }

    async function loadWeek(){
      const monday=getMonday();

      const { data: rules } = await sb
        .from("recurring_rules")
        .select(`
          id, title, weekday, start_time, end_time, location,
          transport_mode, transport_notes,
          required_chaperone_member_id, optional_chaperone_member_ids,
          members ( name )
        `);

      const { data: ex } = await sb
        .from("recurrence_exceptions")
        .select("rule_id,date");

      const byDay=Array.from({length:7},()=>[]);
      rules.forEach(r=>{
        const i = r.weekday;
        const d=new Date(monday); d.setDate(monday.getDate()+i);
        const date = isoDate(d);

        if(ex.some(e=>e.rule_id===r.id && e.date===date)) return;

        const requiredName =
          r.required_chaperone_member_id
            ? (membersCache.find(m=>m.id===r.required_chaperone_member_id)?.name || "ouder")
            : null;

        const optionalNames =
          Array.isArray(r.optional_chaperone_member_ids)
            ? r.optional_chaperone_member_ids
                .map(id => membersCache.find(m=>m.id===id)?.name)
                .filter(Boolean)
            : [];

        byDay[i].push({
          rule_id:r.id,
          who:r.members.name,
          title:r.title,
          time:`${r.start_time.slice(0,5)}‚Äì${r.end_time.slice(0,5)}`,
          date,
          location: r.location || "",
          transport_mode: r.transport_mode || "",
          transport_notes: r.transport_notes || "",
          requiredName,
          optionalNames
        });
      });

      const grid=document.getElementById("week");
      grid.innerHTML="";
      byDay.forEach((items,i)=>{
        const d=new Date(monday); d.setDate(monday.getDate()+i);
        const box=document.createElement("div");
        box.className="day";
        box.innerHTML=`<strong>${dayNames[i]} ${d.getDate()}/${d.getMonth()+1}</strong>`;

        if(items.length===0){
          box.innerHTML+=`<div class="muted">‚Äî</div>`;
        } else {
          const ul=document.createElement("ul");
          items.forEach(it=>{
            const li=document.createElement("li");
            const lines = [];

            lines.push(`<div>${it.time} <b>${it.who}</b>: ${it.title}</div>`);

            if (it.location) lines.push(`<div class="meta">üìç ${it.location}</div>`);
            if (it.transport_mode || it.transport_notes) {
              const t = [it.transport_mode, it.transport_notes].filter(Boolean).join(" ‚Äî ");
              lines.push(`<div class="meta">üöó ${t}</div>`);
            }
            if (it.requiredName) lines.push(`<div class="meta">üë§ moet mee: ${it.requiredName}</div>`);
            if (it.optionalNames.length) lines.push(`<div class="meta">üë• kan mee: ${it.optionalNames.join(", ")}</div>`);

            lines.push(`<button data-rule="${it.rule_id}" data-date="${it.date}">overslaan</button>`);

            li.innerHTML = lines.join("");
            ul.appendChild(li);
          });
          box.appendChild(ul);
        }
        grid.appendChild(box);
      });
    }

    document.getElementById("rule-form").addEventListener("submit", async e=>{
      e.preventDefault();

      await sb.from("recurring_rules").insert({
        member_id: member.value,
        title: title.value,
        location: location.value || null,
        weekday: +weekday.value,
        start_time: start_time.value,
        end_time: end_time.value,
        transport_mode: transport_mode.value || null,
        transport_notes: transport_notes.value || null,
        required_chaperone_member_id: required_chaperone.value || null,
        optional_chaperone_member_ids: getOptionalChaperoneIds()
      });

      e.target.reset();
      // checkboxes resetten
      document.querySelectorAll("#optional_chaperones input[type=checkbox]").forEach(b=>b.checked=false);

      loadWeek();
    });

    document.addEventListener("click", async e=>{
      if(e.target.tagName==="BUTTON" && e.target.dataset.rule){
        await sb.from("recurrence_exceptions").insert({
          rule_id:e.target.dataset.rule,
          date:e.target.dataset.date
        });
        loadWeek();
      }
    });

    (async () => {
      await loadMembers();
      await loadWeek();
    })();
  </script>
</body>
</html>
