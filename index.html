<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezinskalender</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui, sans-serif; }
    #week { display:grid; grid-template-columns:repeat(7,1fr); gap:16px; margin:16px 0 24px; }
    .day { border:1px solid #ddd; border-radius:12px; padding:12px; min-height:120px; }
    .day strong{ display:block; margin-bottom:8px; }
    .day ul{ margin:0 0 0 18px; padding:0; }
    .muted{ color:#777; }
    form{ margin-top:16px; }
  </style>
</head>
<body>
  <h1>Gezinskalender</h1>

  <h2>Deze week</h2>
  <div id="week"></div>

  <h3>Nieuwe wekelijkse activiteit</h3>
  <form id="rule-form">
    <label>Wie:
      <select id="member"></select>
    </label>
    <br><br>
    <label>Titel:
      <input id="title" />
    </label>
    <br><br>
    <label>Dag:
      <select id="weekday">
        <option value="0">Ma</option><option value="1">Di</option><option value="2">Wo</option>
        <option value="3">Do</option><option value="4">Vr</option><option value="5">Za</option><option value="6">Zo</option>
      </select>
    </label>
    <br><br>
    <label>Start:
      <input type="time" id="start_time" />
    </label>
    <br><br>
    <label>Eind:
      <input type="time" id="end_time" />
    </label>
    <br><br>
    <button>Toevoegen</button>
  </form>

  <script>
    const sb = window.supabase.createClient(
      "https://jcwxkicgbctylbdlsbcm.supabase.co",
      "sb_publishable_tF7MRrXQu6x3aBtdvLwmhA_FY4A8Eu3"
    );

    const names = ["Ma","Di","Wo","Do","Vr","Za","Zo"];

    function getMonday(){
      const t=new Date(); const d=(t.getDay()+6)%7;
      const m=new Date(t); m.setDate(t.getDate()-d); m.setHours(0,0,0,0);
      return m;
    }

    async function fillMembers(){
      const { data } = await sb.from("members").select("id,name").order("name");
      const sel=document.getElementById("member");
      sel.innerHTML="";
      data.forEach(m=>{
        const o=document.createElement("option");
        o.value=m.id; o.textContent=m.name; sel.appendChild(o);
      });
    }

    async function loadWeek(){
      const monday=getMonday();
      const next=new Date(monday); next.setDate(monday.getDate()+7);

      const [{data:rules},{data:ex}] = await Promise.all([
        sb.from("recurring_rules").select("*, members(name)"),
        sb.from("recurrence_exceptions").select("rule_id,date")
      ]);

      const byDay=Array.from({length:7},()=>[]);
      rules.forEach(r=>{
        for(let i=0;i<7;i++){
          const d=new Date(monday); d.setDate(monday.getDate()+i);
          if(i!==r.weekday) continue;
          const iso=d.toISOString().slice(0,10);
          if(ex.some(e=>e.rule_id===r.id && e.date===iso)) continue;

          byDay[i].push({
            rule_id:r.id,
            who:r.members.name,
            title:r.title,
            time:`${r.start_time.slice(0,5)}–${r.end_time.slice(0,5)}`,
            date:iso
          });
        }
      });

      const grid=document.getElementById("week");
      grid.innerHTML="";
      byDay.forEach((items,i)=>{
        const d=new Date(monday); d.setDate(monday.getDate()+i);
        const box=document.createElement("div");
        box.className="day";
        box.innerHTML=`<strong>${names[i]} ${d.getDate()}/${d.getMonth()+1}</strong>`;
        if(items.length===0){
          box.innerHTML+=`<div class="muted">—</div>`;
        } else {
          const ul=document.createElement("ul");
          items.forEach(it=>{
            const li=document.createElement("li");
            li.innerHTML=`${it.time} ${it.who}: ${it.title}
              <button data-rule="${it.rule_id}" data-date="${it.date}">overslaan</button>`;
            ul.appendChild(li);
          });
          box.appendChild(ul);
        }
        grid.appendChild(box);
      });
    }

    document.getElementById("rule-form").addEventListener("submit", async e=>{
      e.preventDefault();
      await sb.from("recurring_rules").insert({
        member_id: member.value,
        title: title.value,
        weekday: +weekday.value,
        start_time: start_time.value,
        end_time: end_time.value
      });
      e.target.reset();
      loadWeek();
    });

    document.addEventListener("click", async e=>{
      if(e.target.tagName==="BUTTON" && e.target.dataset.rule){
        await sb.from("recurrence_exceptions").insert({
          rule_id:e.target.dataset.rule,
          date:e.target.dataset.date
        });
        loadWeek();
      }
    });

    fillMembers();
    loadWeek();
  </script>
</body>
</html>
