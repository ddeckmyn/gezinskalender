<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezinskalender</title>
  <link rel="icon" type="image/png" sizes="192x192" href="icon-192.png" />
  <link rel="icon" type="image/png" sizes="512x512" href="icon-512.png" />
  <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Nunito:wght@400;600;700&display=swap");

    :root {
      color-scheme: light;
      font-family: "Nunito", "Segoe UI", sans-serif;
      background: #f7f4ef;
      color: #3a3a3a;
      --soft-orange: #f6b26b;
      --soft-orange-strong: #e08b3f;
      --soft-blue: #b7d7f0;
      --soft-blue-dark: #87b6de;
      --panel: #fff8f0;
      --panel-alt: #f2f7fb;
      --line: #eadfcf;
      --muted: #7b7b7b;
      --shadow: rgba(186, 136, 92, 0.15);
    }

    body {
      margin: 0;
      min-height: 100vh;
      padding: 24px 18px 40px;
      background: linear-gradient(135deg, #fff4e6 0%, #f7f9fb 45%, #eaf4fb 100%);
    }

    h1 {
      font-family: "Fraunces", "Nunito", serif;
      font-size: clamp(2rem, 3vw, 2.6rem);
      margin-bottom: 8px;
    }

    .nav {
      display: flex;
      gap: 12px;
      align-items: center;
      margin: 10px 0 18px;
      flex-wrap: wrap;
    }

    .nav button {
      font-size: 20px;
      padding: 8px 14px;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: var(--panel);
      box-shadow: 0 6px 16px var(--shadow);
      cursor: pointer;
    }

    .nav .label {
      font-weight: 700;
      color: var(--soft-orange-strong);
    }

    #week {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 16px;
      margin: 16px 0 24px;
    }

    .day {
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 14px;
      min-height: 160px;
      background: var(--panel);
      box-shadow: 0 18px 32px var(--shadow);
    }

    .today {
      border-color: var(--soft-blue-dark);
      background: #bfe2ff;
      box-shadow: 0 20px 36px rgba(70, 130, 200, 0.35);
      outline: 3px solid rgba(135, 182, 222, 0.6);
    }

    .day strong {
      display: block;
      margin-bottom: 8px;
      font-size: 1rem;
      color: #4a4a4a;
    }

    .day ul { margin: 0 0 0 18px; padding: 0; }
    .muted { color: var(--muted); }
    .meta { color: #4a4a4a; font-size: 14px; margin-top: 4px; }

    .holiday {
      background: #fff1d6;
      border-color: #f0c68a;
      border-width: 2px;
    }

    .holiday-badge {
      display: inline-block;
      font-size: 12px;
      font-weight: 700;
      padding: 3px 8px;
      border-radius: 999px;
      background: #ffe2b3;
      margin: 6px 0 10px;
    }

    form { margin-top: 12px; max-width: 640px; }
    input, select {
      width: min(100%, 380px);
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--line);
      background: #fff;
    }

    .row { margin: 10px 0; }
    .small { font-size: 14px; }

    .actions button { margin-left: 8px; }
    .actions { display: none; margin-top: 8px; }
    .activity-item { cursor: pointer; }
    .activity-item.open .actions { display: block; }

    .section {
      margin-top: 18px;
      background: var(--panel-alt);
      border-radius: 18px;
      padding: 14px 16px;
      border: 1px solid var(--line);
    }

    .danger { border-color:#f3b1b1 !important; }
    .people { border:1px solid var(--line); border-radius:16px; padding:12px; background: var(--panel); }
    .people ul { margin: 6px 0 0 18px; }

    @media (max-width: 960px) {
      #week { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (max-width: 620px) {
      #week { grid-template-columns: 1fr; }
      .nav { justify-content: space-between; }
      .nav .label { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>Gezinskalender</h1>

  <div class="nav">
    <button id="prev">&larr;</button>
    <div class="label" id="range"></div>
    <button id="next">&rarr;</button>
  </div>

  <div id="week"></div>

  <div class="section">
    <h3>Nieuwe eenmalige activiteit</h3>
    <form id="oneoff-form">
      <div class="row">
        <label>Wie:
          <select id="one_member"></select>
        </label>
      </div>

      <div class="row">
        <label>Activiteit:
          <input id="one_title" />
        </label>
      </div>

      <div class="row">
        <label>Locatie:
          <input id="one_location" placeholder="bv. Dokter" />
        </label>
      </div>

      <div class="row">
        <label>Start:
          <input type="datetime-local" id="one_start" />
        </label>
      </div>

      <div class="row">
        <label>Eind:
          <input type="datetime-local" id="one_end" />
        </label>
      </div>

      <div class="row">
        <label>Transport:
          <select id="one_transport">
            <option value="">(geen)</option>
            <option value="fiets">fiets</option>
            <option value="auto">auto</option>
            <option value="te voet">te voet</option>
            <option value="ov">OV</option>
            <option value="anders">anders</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>Begeleider (moet mee):
          <select id="one_required"></select>
        </label>
      </div>

      <button>Toevoegen</button>
    </form>
  </div>

  <div class="section">
    <h3>Nieuwe wekelijkse activiteit</h3>
    <form id="rule-form">
      <div class="row">
        <label>Wie:
          <select id="member"></select>
        </label>
      </div>

      <div class="row">
        <label>Activiteit:
          <input id="title" />
        </label>
      </div>

      <div class="row">
        <label>Locatie:
          <input id="location_field" placeholder="bv. Sporthal" />
        </label>
      </div>

      <div class="row">
        <label>Dag:
          <select id="weekday">
            <option value="0">Ma</option><option value="1">Di</option><option value="2">Wo</option>
            <option value="3">Do</option><option value="4">Vr</option><option value="5">Za</option><option value="6">Zo</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>Start:
          <input type="time" id="start_time" />
        </label>
      </div>

      <div class="row">
        <label>Eind:
          <input type="time" id="end_time" />
        </label>
      </div>

      <div class="row">
        <label>Transport:
          <select id="transport_mode">
            <option value="">(geen)</option>
            <option value="fiets">fiets</option>
            <option value="auto">auto</option>
            <option value="te voet">te voet</option>
            <option value="ov">OV</option>
            <option value="anders">anders</option>
          </select>
        </label>
      </div>

      <div class="row">
        <label>Transport-notitie:
          <input id="transport_notes" placeholder="bv. Nathalie brengt, fiets mee" />
        </label>
      </div>

      <div class="row">
        <label>Begeleider (moet mee):
          <select id="required_chaperone"></select>
        </label>
        <div class="small muted">Laat leeg als niemand verplicht mee moet.</div>
      </div>

      <button>Toevoegen</button>
    </form>
    <div id="rule-status" class="small muted"></div>
  </div>

  <div class="section people">
    <h3>Personen</h3>
    <ul id="people-list"></ul>

    <form id="person-form">
      <div class="row">
        <label>Naam:
          <input id="person_name" placeholder="bv. Oma" />
        </label>
      </div>

      <div class="row">
        <label>Rol:
          <select id="person_role">
            <option value="ouder">ouder</option>
            <option value="kind">kind</option>
            <option value="verzorger">verzorger</option>
          </select>
        </label>
      </div>

      <button>Persoon toevoegen</button>
      <div class="small muted">Deactiveren is veiliger dan wissen: oude afspraken blijven intact.</div>
    </form>
  </div>

  

  

  

  <p><a href="/tv.html">TV-modus</a></p>

  <script>
    const sb = window.supabase.createClient(
      "https://jcwxkicgbctylbdlsbcm.supabase.co",
      "sb_publishable_tF7MRrXQu6x3aBtdvLwmhA_FY4A8Eu3"
    );

    const dayNames = ["Ma","Di","Wo","Do","Vr","Za","Zo"];
    let weekOffset = 0;
    let membersCache = [];
    let holidayCache = [];

    function mondayForOffset(offset){
      const t=new Date();
      const d=(t.getDay()+6)%7;
      const m=new Date(t);
      m.setDate(t.getDate()-d + offset*7);
      m.setHours(0,0,0,0);
      return m;
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function toLocalISO(dtLocal){ return new Date(dtLocal).toISOString(); }

    function dateInHoliday(dateIso){
      for (const h of holidayCache) {
        if (dateIso >= h.start_date && dateIso <= h.end_date) return h.name;
      }
      return null;
    }

    async function loadMembers(){
      const { data, error } = await sb.from("members").select("id,name,role,is_active").order("name");
      if (error) { console.error("members error", error); membersCache = []; return; }
      membersCache = data || [];

      // Personenlijst (actief + inactief)
      const peopleList = document.getElementById("people-list");
      peopleList.innerHTML = "";
      membersCache.forEach(m => {
        const li = document.createElement("li");
        li.innerHTML = `${m.name} (${m.role}) ${m.is_active ? "" : "<span class='muted'>(inactief)</span>"}
          ${m.is_active ? `<button data-deactivate-member="${m.id}">deactiveer</button>` : ""}`;
        peopleList.appendChild(li);
      });

      // dropdowns enkel actieve
      const active = membersCache.filter(m => m.is_active);

      const sel = document.getElementById("member");
      const oneSel = document.getElementById("one_member");
      sel.innerHTML = ""; oneSel.innerHTML = "";
      active.forEach(m=>{
        const o=document.createElement("option"); o.value=m.id; o.textContent=m.name;
        sel.appendChild(o);
        const o2=o.cloneNode(true);
        oneSel.appendChild(o2);
      });

      const req = document.getElementById("required_chaperone");
      const oneReq = document.getElementById("one_required");
      req.innerHTML = `<option value="">(niemand)</option>`;
      oneReq.innerHTML = `<option value="">(niemand)</option>`;

      active.filter(m=>m.role==="ouder" || m.role==="verzorger").forEach(m=>{
        const o=document.createElement("option"); o.value=m.id; o.textContent=m.name;
        req.appendChild(o);
        const o2=o.cloneNode(true);
        oneReq.appendChild(o2);
      });

    }

    async function loadHolidays(){
      const { data, error } = await sb
        .from("holiday_events")
        .select("name,start_date,end_date,region,schoolyear")
        .eq("region","Vlaanderen")
        .eq("schoolyear","2025-2026");
      if (error) { console.error("holidays error", error); holidayCache = []; return; }
      holidayCache = data || [];
    }

    function normalizeId(value){
      if (value === null || value === undefined || value === "") return null;
      return /^\d+$/.test(String(value)) ? Number(value) : value;
    }

    async function loadWeek(){
      const monday = mondayForOffset(weekOffset);
      const next = new Date(monday); next.setDate(monday.getDate()+7);
      const todayIso = isoDate(new Date());

      const rangeEl = document.getElementById("range");
      const endLabel = new Date(next); endLabel.setDate(next.getDate()-1);
      rangeEl.textContent = `Week van ${monday.getDate()}/${monday.getMonth()+1} tot ${endLabel.getDate()}/${endLabel.getMonth()+1}`;

      const rulesRes = await sb
        .from("recurring_rules")
        .select(`
          id, member_id, title, weekday, start_time, end_time, location,
          transport_mode, transport_notes,
          required_chaperone_member_id
        `);

      const exRes = await sb.from("recurrence_exceptions").select("rule_id,date");

      const oneRes = await sb
        .from("activities")
        .select(`id, member_id, title, location, start_at, end_at, transport, required_chaperone`)
        .gte("start_at", monday.toISOString())
        .lt("start_at", next.toISOString())
        .order("start_at");

      if (rulesRes.error) console.error("rules error", rulesRes.error);
      if (exRes.error) console.error("exceptions error", exRes.error);
      if (oneRes.error) console.error("oneoff error", oneRes.error);

      const rules = rulesRes.data || [];
      const ex = exRes.data || [];
      const oneOffs = oneRes.data || [];

      const byDay = Array.from({ length: 7 }, () => []);

      // recurring occurrences (alleen voor actieve members)
      rules.forEach(r => {
        const i = r.weekday;
        const d = new Date(monday); d.setDate(monday.getDate() + i);
        const date = isoDate(d);

        if (ex.some(e => e.rule_id === r.id && e.date === date)) return;

        const memberActive = membersCache.find(m => m.id === r.member_id)?.is_active;
        if (memberActive === false) return;

        const whoName =
          membersCache.find(m => m.id === r.member_id)?.name
          || "Onbekend";

        const requiredName =
          r.required_chaperone_member_id
            ? (membersCache.find(m => m.id === r.required_chaperone_member_id)?.name || "ouder")
            : null;

        byDay[i].push({
          kind: "rule",
          rule_id: r.id,
          date,
          who: whoName,
          title: r.title,
          time: `${r.start_time.slice(0,5)}-${r.end_time.slice(0,5)}`,
          location: r.location || "",
          transport_mode: r.transport_mode || "",
          transport_notes: r.transport_notes || "",
          requiredName
        });
      });

      // one-offs (alleen actieve members) â€” nu op member_id
      oneOffs.forEach(a => {
        const memberActive = membersCache.find(m => m.id === a.member_id)?.is_active;
        if (memberActive === false) return;

        const who =
          membersCache.find(m => m.id === a.member_id)?.name
          || "Onbekend";

        const d = new Date(a.start_at);
        const idx = (d.getDay() + 6) % 7;
        byDay[idx].push({
          kind: "one",
          activity_id: a.id,
          who,
          title: a.title,
          time: new Date(a.start_at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}),
          location: a.location || "",
          transport_mode: a.transport || "",
          requiredName: a.required_chaperone || null
        });
      });

      byDay.forEach(arr => arr.sort((x,y)=> (x.time||"").localeCompare(y.time||"")));

      const grid = document.getElementById("week");
      grid.innerHTML = "";

      byDay.forEach((items, i) => {
        const d = new Date(monday); d.setDate(monday.getDate()+i);
        const date = isoDate(d);
        const holidayName = dateInHoliday(date);

        const box = document.createElement("div");
        box.className = "day" + (date === todayIso ? " today" : "") + (holidayName ? " holiday" : "");
        box.innerHTML = `<strong>${dayNames[i]} ${d.getDate()}/${d.getMonth()+1}</strong>`;
        if (holidayName) box.innerHTML += `<div class="holiday-badge">schoolvakantie: ${holidayName}</div>`;

        if (items.length === 0) {
          box.innerHTML += `<div class="muted">-</div>`;
        } else {
          const ul = document.createElement("ul");
          items.forEach(it => {
            const li = document.createElement("li");
            li.className = "activity-item";
            const lines = [];
            lines.push(`<div>${it.time} <b>${it.who}</b>: ${it.title}</div>`);
            if (it.location) lines.push(`<div class="meta">Locatie: ${it.location}</div>`);
            if (it.transport_mode || it.transport_notes) {
              const t = [it.transport_mode, it.transport_notes].filter(Boolean).join(" - ");
              lines.push(`<div class="meta">Transport: ${t}</div>`);
            }
            if (it.requiredName) lines.push(`<div class="meta">Begeleider: ${it.requiredName}</div>`);

            if (it.kind === "rule") {
              lines.push(
                `<div class="actions">
                   <button data-skip-rule="${it.rule_id}" data-skip-date="${it.date}">Verwijder (alleen deze datum)</button>
                   <button class="danger" data-del-rule="${it.rule_id}">Verwijder wekelijkse regel (altijd)</button>
                 </div>`
              );
            } else {
              lines.push(
                `<div class="actions">
                   <button class="danger" data-del-activity="${it.activity_id}">Verwijder (definitief)</button>
                 </div>`
              );
            }

            li.innerHTML = lines.join(" - ");
            ul.appendChild(li);
          });
          box.appendChild(ul);
        }

        grid.appendChild(box);
      });
    }

    document.getElementById("prev").addEventListener("click", () => { weekOffset -= 1; loadWeek(); });
    document.getElementById("next").addEventListener("click", () => { weekOffset += 1; loadWeek(); });

    document.getElementById("person-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const name = person_name.value.trim();
      const role = person_role.value;
      if (!name) return;

      const res = await sb.from("members").insert({ name, role, is_active: true });
      if (res.error) { alert("Persoon toevoegen mislukt: " + res.error.message); console.error(res.error); return; }

      e.target.reset();
      await loadMembers();
      await loadWeek();
    });

    document.getElementById("rule-form").addEventListener("submit", async e => {
      e.preventDefault();
      const statusEl = document.getElementById("rule-status");
      statusEl.textContent = "";
      const memberEl = document.getElementById("member");
      const titleEl = document.getElementById("title");
      const locationEl = document.getElementById("location_field");
      const weekdayEl = document.getElementById("weekday");
      const startEl = document.getElementById("start_time");
      const endEl = document.getElementById("end_time");
      const transportModeEl = document.getElementById("transport_mode");
      const transportNotesEl = document.getElementById("transport_notes");
      const requiredEl = document.getElementById("required_chaperone");

      if (!memberEl.value || !titleEl.value.trim() || !startEl.value || !endEl.value) {
        alert("Vul minstens in: wie, activiteit, start en eind.");
        return;
      }

      if (endEl.value <= startEl.value) {
        alert("Eindtijd moet na de starttijd liggen.");
        return;
      }

      const res = await sb.from("recurring_rules").insert({
        member_id: normalizeId(memberEl.value),
        title: titleEl.value.trim(),
        location: locationEl.value.trim() || null,
        weekday: +weekdayEl.value,
        start_time: startEl.value,
        end_time: endEl.value,
        transport_mode: transportModeEl.value || null,
        transport_notes: transportNotesEl.value || null,
        required_chaperone_member_id: normalizeId(requiredEl.value)
      }).select("id").single();

      if (res.error) {
        statusEl.textContent = "Opslaan mislukt: " + res.error.message;
        statusEl.classList.remove("muted");
        statusEl.style.color = "#b00020";
        console.error(res.error);
        return;
      }

      e.target.reset();
      statusEl.textContent = "Activiteit toegevoegd.";
      statusEl.classList.remove("muted");
      statusEl.style.color = "#0a7d2b";
      loadWeek();
    });

    document.getElementById("oneoff-form").addEventListener("submit", async e => {
      e.preventDefault();

      if (!one_member.value || !one_title.value.trim() || !one_start.value) {
        alert("Vul minstens in: wie, activiteit, start.");
        return;
      }

      const res = await sb.from("activities").insert({
        member_id: normalizeId(one_member.value),
        title: one_title.value.trim(),
        location: one_location.value || null,
        start_at: toLocalISO(one_start.value),
        end_at: one_end.value ? toLocalISO(one_end.value) : null,
        transport: one_transport.value || null,
        required_chaperone: one_required.value
          ? (membersCache.find(m=>m.id===one_required.value)?.name || null)
          : null
      });

      if (res.error) {
        alert("Opslaan mislukt: " + res.error.message);
        console.error(res.error);
        return;
      }

      e.target.reset();
      loadWeek();
    });

    document.addEventListener("click", async e => {
      const item = e.target.closest(".activity-item");
      if (item && !e.target.closest("button")) {
        item.classList.toggle("open");
      }

      if (e.target.dataset.skipRule) {
        const res = await sb.from("recurrence_exceptions").insert({
          rule_id: e.target.dataset.skipRule,
          date: e.target.dataset.skipDate
        });
        if (res.error) { alert("Kon niet verwijderen voor deze datum: " + res.error.message); console.error(res.error); return; }
        loadWeek();
      }

      if (e.target.dataset.delRule) {
        if (!confirm("Deze wekelijkse regel ALTIJD verwijderen (ook alle toekomstige weken)?")) return;
        const res = await sb.from("recurring_rules").delete().eq("id", e.target.dataset.delRule);
        if (res.error) { alert("Kon regel niet verwijderen: " + res.error.message); console.error(res.error); return; }
        loadWeek();
      }

      if (e.target.dataset.delActivity) {
        if (!confirm("Deze eenmalige activiteit definitief verwijderen?")) return;
        const res = await sb.from("activities").delete().eq("id", e.target.dataset.delActivity);
        if (res.error) { alert("Kon activiteit niet verwijderen: " + res.error.message); console.error(res.error); return; }
        loadWeek();
      }

      if (e.target.dataset.deactivateMember) {
        if (!confirm("Deze persoon deactiveren? (wordt niet meer getoond in de week)")) return;
        const res = await sb.from("members").update({ is_active: false }).eq("id", e.target.dataset.deactivateMember);
        if (res.error) { alert("Kon persoon niet deactiveren: " + res.error.message); console.error(res.error); return; }
        await loadMembers();
        await loadWeek();
      }
    });

    (async () => {
      await loadMembers();
      await loadHolidays();
      await loadWeek();
    })();
  </script>
</body>
</html>






