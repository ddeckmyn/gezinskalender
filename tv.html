<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezinskalender - TV</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    @import url("https://fonts.googleapis.com/css2?family=Fraunces:wght@600;700&family=Nunito:wght@400;600;700&display=swap");

    :root {
      color-scheme: light;
      font-family: "Nunito", "Segoe UI", sans-serif;
      background: #f7f4ef;
      color: #2e2e2e;
      --soft-orange: #f6b26b;
      --soft-blue: #b7d7f0;
      --panel: #f0f6ff;
      --line: #eadfcf;
      --shadow: rgba(96, 132, 178, 0.22);
    }

    body {
      margin: 0;
      font-size: 26px;
      padding: 28px;
      background: linear-gradient(140deg, #fff4e6 0%, #eef6ff 50%, #cfe5ff 100%);
    }

    h1 {
      font-family: "Fraunces", "Nunito", serif;
      font-size: 46px;
      margin: 0 0 14px;
      color: #d07a2b;
    }

    #week {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
      gap: 14px;
    }

    .day {
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 12px 14px;
      min-height: 160px;
      background: var(--panel);
      box-shadow: 0 18px 34px var(--shadow);
    }

    .today {
      border-width: 4px;
      border-color: #6aa8de;
      background: #c6e4ff;
      box-shadow: 0 22px 36px rgba(85, 145, 210, 0.35);
    }

    .holiday {
      background: #fff1d6;
      border-color:#f0c68a;
      border-width:2px;
    }

    .badge {
      display:inline-block;
      font-size:14px;
      font-weight:700;
      padding:3px 10px;
      border-radius:999px;
      background:#ffe2b3;
      margin: 6px 0 10px;
    }

    .day strong {
      display:block;
      font-size: 28px;
      margin-bottom: 6px;
    }

    .item { margin: 10px 0; }
    .meta { font-size: 18px; opacity: 0.85; margin-top: 2px; }
    .muted { opacity: 0.6; }

    @media (max-width: 1200px) {
      #week { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    @media (max-width: 860px) {
      #week { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
  </style>
</head>
<body>
  <h1>Deze week</h1>
  <div id="week"></div>

  <script>
    const sb = window.supabase.createClient(
      "https://jcwxkicgbctylbdlsbcm.supabase.co",
      "sb_publishable_tF7MRrXQu6x3aBtdvLwmhA_FY4A8Eu3"
    );

    const dayNames = ["Ma","Di","Wo","Do","Vr","Za","Zo"];
    let membersCache = [];
    let holidayCache = [];

    function getMonday(){
      const t=new Date(); const d=(t.getDay()+6)%7;
      const m=new Date(t); m.setDate(t.getDate()-d); m.setHours(0,0,0,0);
      return m;
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }
    function dateInHoliday(dateIso){
      for (const h of holidayCache) {
        if (dateIso >= h.start_date && dateIso <= h.end_date) return h.name;
      }
      return null;
    }

    async function loadMembers(){
      const { data } = await sb.from("members").select("id,name,role").order("name");
      membersCache = data || [];
    }
    async function loadHolidays(){
      const { data } = await sb
        .from("holiday_events")
        .select("name,start_date,end_date,region,schoolyear")
        .eq("region","Vlaanderen")
        .eq("schoolyear","2025-2026");
      holidayCache = data || [];
    }

    async function renderWeek(){
      const monday = getMonday();
      const next = new Date(monday); next.setDate(monday.getDate()+7);
      const todayIso = isoDate(new Date());

      const rulesRes = await sb
        .from("recurring_rules")
        .select(`
          id, member_id, title, weekday, start_time, end_time, location,
          transport_mode, transport_notes,
          required_chaperone_member_id
        `);

      const exRes = await sb.from("recurrence_exceptions").select("rule_id,date");

      const oneRes = await sb
        .from("activities")
        .select(`id, member_id, title, location, start_at, transport, required_chaperone`)
        .gte("start_at", monday.toISOString())
        .lt("start_at", next.toISOString())
        .order("start_at");

      const rules = rulesRes.data || [];
      const ex = exRes.data || [];
      const oneOffs = oneRes.data || [];

      const byDay = Array.from({ length: 7 }, () => []);

      rules.forEach(r => {
        const i = r.weekday;
        const d = new Date(monday); d.setDate(monday.getDate() + i);
        const date = isoDate(d);
        if (ex.some(e => e.rule_id === r.id && e.date === date)) return;

        const requiredName =
          r.required_chaperone_member_id
            ? (membersCache.find(m => m.id === r.required_chaperone_member_id)?.name || "ouder")
            : null;

        const who =
          membersCache.find(m => m.id === r.member_id)?.name
          || "Onbekend";

        byDay[i].push({
          kind:"rule",
          who,
          title:r.title,
          time:`${r.start_time.slice(0,5)}-${r.end_time.slice(0,5)}`,
          date,
          location:r.location||"",
          transport_mode:r.transport_mode||"",
          transport_notes:r.transport_notes||"",
          requiredName
        });
      });

      oneOffs.forEach(a => {
        const d = new Date(a.start_at);
        const idx = (d.getDay() + 6) % 7;
        const who =
          membersCache.find(m => m.id === a.member_id)?.name
          || "Onbekend";

        byDay[idx].push({
          kind:"one",
          who,
          title:a.title,
          time:new Date(a.start_at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}),
          date: isoDate(d),
          location:a.location||"",
          transport_mode:a.transport||"",
          requiredName:a.required_chaperone||null
        });
      });

      byDay.forEach(arr => arr.sort((x,y)=> (x.time||"").localeCompare(y.time||"")));

      const grid = document.getElementById("week");
      grid.innerHTML = "";

      byDay.forEach((items, i) => {
        const d = new Date(monday); d.setDate(monday.getDate() + i);
        const date = isoDate(d);
        const holidayName = dateInHoliday(date);

        const box = document.createElement("div");
        box.className = "day"
          + (date === todayIso ? " today" : "")
          + (holidayName ? " holiday" : "");

        box.innerHTML = `<strong>${dayNames[i]} ${d.getDate()}/${d.getMonth()+1}</strong>`;
        if (holidayName) box.innerHTML += `<div class="badge">schoolvakantie: ${holidayName}</div>`;

        if (items.length === 0) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "-";
          box.appendChild(p);
        } else {
          items.forEach(it => {
            const wrap = document.createElement("div");
            wrap.className = "item";
            wrap.innerHTML = `<div>${it.time} <b>${it.who}</b>: ${it.title}</div>`;

            if (it.location) wrap.innerHTML += `<div class="meta">Locatie: ${it.location}</div>`;
            if (it.transport_mode || it.transport_notes) {
              const t = [it.transport_mode, it.transport_notes].filter(Boolean).join(" - ");
              wrap.innerHTML += `<div class="meta">Transport: ${t}</div>`;
            }
            if (it.requiredName) wrap.innerHTML += `<div class="meta">Begeleider: ${it.requiredName}</div>`;

            box.appendChild(wrap);
          });
        }

        grid.appendChild(box);
      });
    }

    (async () => {
      await loadMembers();
      await loadHolidays();
      await renderWeek();
      setInterval(renderWeek, 60_000);
    })();
  </script>
</body>
</html>

