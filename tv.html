<!doctype html>
<html lang="nl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Gezinskalender ‚Äì TV</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body { font-family: system-ui, sans-serif; font-size: 28px; padding: 32px; }
    h1 { font-size: 44px; margin: 0 0 16px; }
    #week { display:grid; grid-template-columns:repeat(7,1fr); gap:16px; }
    .day { border:1px solid #ddd; border-radius:16px; padding:14px; min-height:160px; }
    .today { border-width: 3px; }
    .day strong{ display:block; font-size: 30px; margin-bottom: 8px; }
    .item { margin: 10px 0; }
    .meta { font-size: 20px; opacity: 0.85; margin-top: 2px; }
    .muted { opacity: 0.6; }
  </style>
</head>
<body>
  <h1>Deze week</h1>
  <div id="week"></div>

  <script>
    const sb = window.supabase.createClient(
      "https://jcwxkicgbctylbdlsbcm.supabase.co",
      "sb_publishable_tF7MRrXQu6x3aBtdvLwmhA_FY4A8Eu3"
    );

    const dayNames = ["Ma","Di","Wo","Do","Vr","Za","Zo"];

    function getMonday(){
      const t=new Date(); const d=(t.getDay()+6)%7;
      const m=new Date(t); m.setDate(t.getDate()-d); m.setHours(0,0,0,0);
      return m;
    }
    function isoDate(d){ return d.toISOString().slice(0,10); }

    let membersCache = [];

    async function loadMembers(){
      const { data, error } = await sb.from("members").select("id,name,role").order("name");
      if (error) { console.error("members error", error); membersCache = []; return; }
      membersCache = data || [];
    }

    async function renderTVWeek(){
      const monday = getMonday();
      const todayIso = isoDate(new Date());

      const rulesRes = await sb
        .from("recurring_rules")
        .select(`
          id, title, weekday, start_time, end_time, location,
          transport_mode, transport_notes,
          required_chaperone_member_id, optional_chaperone_member_ids,
          members ( name )
        `);

      const exRes = await sb
        .from("recurrence_exceptions")
        .select("rule_id,date");

      if (rulesRes.error) console.error("rules error", rulesRes.error);
      if (exRes.error) console.error("exceptions error", exRes.error);

      const rules = rulesRes.data || [];
      const ex = exRes.data || [];

      const byDay = Array.from({ length: 7 }, () => []);

      rules.forEach(r => {
        const i = r.weekday;
        const d = new Date(monday); d.setDate(monday.getDate() + i);
        const date = isoDate(d);

        if (ex.some(e => e.rule_id === r.id && e.date === date)) return;

        const requiredName =
          r.required_chaperone_member_id
            ? (membersCache.find(m => m.id === r.required_chaperone_member_id)?.name || "ouder")
            : null;

        const optionalNames =
          Array.isArray(r.optional_chaperone_member_ids)
            ? r.optional_chaperone_member_ids
                .map(id => membersCache.find(m => m.id === id)?.name)
                .filter(Boolean)
            : [];

        byDay[i].push({
          who: r.members.name,
          title: r.title,
          time: `${r.start_time.slice(0,5)}‚Äì${r.end_time.slice(0,5)}`,
          date,
          location: r.location || "",
          transport_mode: r.transport_mode || "",
          transport_notes: r.transport_notes || "",
          requiredName,
          optionalNames
        });
      });

      const grid = document.getElementById("week");
      grid.innerHTML = "";

      byDay.forEach((items, i) => {
        const d = new Date(monday); d.setDate(monday.getDate() + i);
        const box = document.createElement("div");
        box.className = "day" + (isoDate(d) === todayIso ? " today" : "");
        box.innerHTML = `<strong>${dayNames[i]} ${d.getDate()}/${d.getMonth()+1}</strong>`;

        if (items.length === 0) {
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "‚Äî";
          box.appendChild(p);
        } else {
          items.forEach(it => {
            const wrap = document.createElement("div");
            wrap.className = "item";
            wrap.innerHTML = `<div>${it.time} <b>${it.who}</b>: ${it.title}</div>`;

            if (it.location) wrap.innerHTML += `<div class="meta">üìç ${it.location}</div>`;
            if (it.transport_mode || it.transport_notes) {
              const t = [it.transport_mode, it.transport_notes].filter(Boolean).join(" ‚Äî ");
              wrap.innerHTML += `<div class="meta">üöó ${t}</div>`;
            }
            if (it.requiredName) wrap.innerHTML += `<div class="meta">üë§ moet mee: ${it.requiredName}</div>`;
            if (it.optionalNames.length) wrap.innerHTML += `<div class="meta">üë• kan mee: ${it.optionalNames.join(", ")}</div>`;

            box.appendChild(wrap);
          });
        }

        grid.appendChild(box);
      });
    }

    (async () => {
      await loadMembers();
      await renderTVWeek();
      setInterval(renderTVWeek, 60_000); // auto-refresh elke minuut
    })();
  </script>
</body>
</html>
32